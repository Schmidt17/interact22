<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Slider Controller</title>

    <link type="text/css" rel="stylesheet" href="css/style.css"  media="screen,projection"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
    <div id="app"></div>

    <script src="js/moment.min.js" type="text/javascript"></script>
    <script src="js/paho_mqtt.min.js" type="text/javascript"></script>

    <script src="js/main.js" type="text/javascript"></script>

    <script>
        const app = Elm.Main.init({
            node: document.getElementById('app')
        });

        app.ports.receiveMQTTMessage.send("Here the last MQTT message will be displayed!");

        const mqtt_host = "picluster.a-h.wtf";
        const mqtt_port = 8883;

        // create a client instance
        const client = new Paho.MQTT.Client(mqtt_host, mqtt_port, "controller-web-elm_" + String(moment().unix()) + String(moment().milliseconds())); // with clientid empty, broker will generate one. To have more control, we create one ourselves

        // set callback functions
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // connect the client
        function connect() {
          console.log("Trying to connect to MQTT broker at " + mqtt_host + ":" + mqtt_port + " ...");

          client.connect({
            onSuccess: onConnectSuccess,  // onConnectSuccess is called when the connection is established
            useSSL: true
          });
        }

        connect();

        // called when the client connects
        function onConnectSuccess() {
          // Once a connection has been made, subscribe to the needed channels
          console.log("Connected to MQTT broker at " + mqtt_host + ":" + mqtt_port);
          // client.subscribe(thing_id + "/humidity");
          // client.subscribe("astridtest/valves");
          // waterBtn.classList.remove("disabled");
          client.subscribe("interact/test");
          console.log("Subscribed to topic interact/test");
        }

        // called when the client loses its connection
        function onConnectionLost(responseObject) {
          if (responseObject.errorCode !== 0) {
            console.log("onConnectionLost:" + responseObject.errorMessage);
          }

          console.log("Trying to reconnect ...");
          connect();
        }

        // called when a message arrives
        function onMessageArrived(message) {
          const msg_string = message.payloadString;
          // msg_dict = JSON.parse(message.payloadString);
          // // console.log(msg_dict);

          // if (message.destinationName == 'astridtest/valves') {
          //   handleActuatorMessage(msg_dict);
          // } else if (message.destinationName == 'astridtest/sensors') {
          //   handleSensorMessage(msg_dict);
          // }

          app.ports.receiveMQTTMessage.send(message.payloadString);
        }
    </script>
</body>
</html>